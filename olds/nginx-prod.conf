# Ce fichier est copié en tant que /etc/nginx/conf.d/etudiant.com.conf dans le conteneur.
# ----------------------------------------------------------------
# BLOC 1 : Serveur principal pour etudiant.enclume-numerique.com (HTTPS)
# ----------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name etudiant.enclume-numerique.com;

    # --- IMPORTANT : Chemin vers votre NOUVEAU certificat ---
    # Ce certificat doit couvrir "etudiant..." ET "www.etudiant...".
    ssl_certificate /etc/letsencrypt/live/etudiant.enclume-numerique.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/etudiant.enclume-numerique.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # --- CORRECTION PRINCIPALE ---
    # Le chemin pointe maintenant vers le répertoire correct défini dans le Dockerfile.dev.
    root /usr/share/nginx/html/etudiant;
    index index.html;

    # Proxy pour les appels API vers le backend Spring Boot ('app' est le nom du service Docker)
    location /api/ {
        proxy_pass http://app:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Support pour le routage Angular (redirige toutes les autres requêtes vers index.html)
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# ----------------------------------------------------------------
# BLOC 2 : Rediriger www.etudiant.* vers etudiant.* (HTTPS)
# ----------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name www.etudiant.enclume-numerique.com;

    # On utilise ici aussi le même certificat
    ssl_certificate /etc/letsencrypt/live/etudiant.enclume-numerique.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/etudiant.enclume-numerique.com/privkey.pem;

    # Redirection permanente (SEO-friendly) vers la version sans "www"
    return 301 https://etudiant.enclume-numerique.com$request_uri;
}

# ----------------------------------------------------------------
# BLOC 3 : Redirection de tout le trafic HTTP vers HTTPS
# ----------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;

    server_name etudiant.enclume-numerique.com www.etudiant.enclume-numerique.com;

    # Gestion du renouvellement automatique de certificat par Certbot
    location /.well-known/acme-challenge/ {
        allow all;
        root /var/www/certbot;
    }

    # Redirection de toutes les autres requêtes HTTP vers HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}
