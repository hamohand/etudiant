# Ce fichier est copié en tant que /etc/nginx/conf.d/etudiant.com.conf dans le conteneur.

# ----------------------------------------------------------------
# BLOC 1 : Serveur principal pour etudiant.enclume-numerique.com (HTTPS)
# ----------------------------------------------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Le nom de domaine principal (canonique)
    server_name etudiant.enclume-numerique.com;

    # --- IMPORTANT : Chemin vers votre NOUVEAU certificat partagé ---
    # Le chemin dépend du premier domaine (-d) utilisé lors de la création du cert.
    ssl_certificate /etc/letsencrypt/live/etudiant.enclume-numerique.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/etudiant.enclume-numerique.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Définir le répertoire racine pour les fichiers statiques de l'application Angular
    root /usr/share/nginx/html;
    index index.html;

    # Proxy pour les appels API vers le backend Spring Boot
    location /api/ {
        proxy_pass http://app:8080/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Support pour le routage Angular (gère les rechargements de page)
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# ----------------------------------------------------------------
# BLOC 2 : Rediriger www.etudiant.* vers etudiant.* (HTTPS)
# ----------------------------------------------------------------
# Ce bloc s'assure que les utilisateurs arrivant sur la version "www"
# sont redirigés de manière permanente vers la version sans "www".
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name www.etudiant.enclume-numerique.com;

    # On utilise ici aussi le NOUVEAU certificat
    ssl_certificate /etc/letsencrypt/live/etudiant.enclume-numerique.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/etudiant.enclume-numerique.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Redirection permanente (SEO-friendly) vers la version sans "www"
    return 301 https://etudiant.enclume-numerique.com$request_uri;
}

# ----------------------------------------------------------------
# BLOC 3 : Redirection de tout le trafic HTTP vers HTTPS
# ----------------------------------------------------------------
server {
    listen 80;
    listen [::]:80;

    # Écoute pour les deux noms de domaine sur le port 80
    server_name etudiant.enclume-numerique.com www.etudiant.enclume-numerique.com;

    # Gestion du renouvellement automatique de certificat par Certbot
    location /.well-known/acme-challenge/ {
        allow all;
        root /var/www/certbot;
    }

    # Redirection de toutes les autres requêtes HTTP vers HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}
